{% extends "home.html" %} {% block scripts %} {{ super() }}
<script>
    var listLoaded = false;
    $("Document").ready(function () {
        var nickname = $.cookie("nickname");
        if (!nickname) {
            window.location.href = "/";
        }
        if (listLoaded) {
            return;
        }
        var setEmptyHtml = function () {
            $("#articleListEmpty").removeClass("hidden");
        };
        $.ajax({
            url: "/api/v1/articles",
            type: "get",
            dataType: "json",
            data: {
                offset: 0,
                limit: 10
            },
            success: function (data, status) {
                if (data.code != 200) {
                    console.log(status);
                    setEmptyHtml();
                } else {
                    var $articleList = $("#articleList");
                    var articleListData = data.list;
                    var listLength = articleListData.length;
                    if (!listLength) {
                        setEmptyHtml();
                    } else {
                        var articleListHtml = $("#articleTemplate").html();
                        for (var i = 0; i < listLength; i++) {
                            var article = articleListData[i];
                            $articleList.append(articleListHtml);
                            var $newArticle = $articleList.children("[name=articleBox]:last");
                            $newArticle.attr("aid", article.id);
                            var $articleTitle = $newArticle.find("[name=articleTitle]");
                            $articleTitle.text(article.title);
                            $articleTitle.attr("href", "/articles/" + article.id + "/read");
                            $newArticle.find("[name=articleCreateTime]").text(timestamp2Date(
                                article.create_time));
                            var aHtml = article.html;
                            var $articleHtmls = $newArticle.find("[name=articleHtml]");
                            if (!aHtml) {
                                $articleHtmls.html("<p>什么都没有呀~写点什么吧!</p>");
                            } else {
                                $articleHtmls.html(article.html);
                            }
                            $newArticle.find("[name=articleAuthorLink]").text(article.author);
                            $newArticle.find("[name=articleViews]").text(article.view_count);
                        }
                        $articleList.find("[name=articleEdit]").click(function () {
                            var articleId = $(this).parents("[name=articleBox]").attr("aid");
                            window.location.href = "/articles/" + articleId + "/write";
                        });
                        $articleList.find("[name=articleDelete]").click(function () {
                            var articleId = $(this).parents("[name=articleBox]").attr("aid");
                            $.ajax({
                                url: "/api/v1/articles/" + articleId,
                                type: "delete",
                                dataType: "json",
                                success: function (data, status) {
                                    if (data.code != 200) {
                                        alert("删除失败, 请稍候重试!");
                                    } else {
                                        $articleList.children("[aid=" +
                                            articleId + "]").addClass(
                                            "hidden");
                                    }
                                }
                            });
                            return false;
                        });
                    }
                }
            },
            error: function () {
                setEmptyHtml();
            }
        });
        listLoaded = true;
    })
</script>
{% endblock %} {% block article %}
<div class="text-center">
    <h2>
        <span class="glyphicon glyphicon-leaf"></span id="articleCategory">Javascript
    </h2>
</div>
<div class="row">
    <div class="col-sm-4 col-sm-offset-4">
        <hr>
    </div>
</div>
<div id="articleList">
</div>
<div id="articleListEmpty" class="hidden text-center">
    <h1>空空如也!</h1>
</div>
<div id="articleTemplate" class="hidden">
    <div name="articleBox" aid="-1">
        <div class="bs-callout bs-callout-my">
            <div class="text-center">
                <div class="dropdown  pull-right">
                    <button class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#" name="articleEdit">编辑</a>
                        </li>
                        <li>
                            <a href="#" name="articleRevoke">取消发布</a>
                        </li>
                        <li role="separator" class="divider"></li>
                        <li>
                            <a href="#" name="articleDelete">删除</a>
                        </li>
                    </ul>
                </div>
                <h4>
                    <a href="#" name="articleTitle"></a>
                </h4>
                <small class="text-muted" name="articleCreateTime"></small>
            </div>
            <hr>
            <div>
                <div name="articleHtml"></div>
            </div>
            <div>
                <span class="label label-success">
                    <a href="#aboutme" name="articleAuthorLink"></a>
                </span>
                <span>
                    &nbsp;
                    <small class="glyphicon glyphicon-eye-open"></small>
                    <small name="articleViews"></small>
                </span>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-sm-offset-4">
                <hr>
            </div>
        </div>
    </div>
</div>
{% endblock %}